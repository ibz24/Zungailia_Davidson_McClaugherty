---
title: "Data Processing & Wrangling"
author: "Megan McClaugherty"
date: "2022-11-21"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
#Check working directory
getwd()

#Load necessary packages
library(dplyr)
library(lubridate)
library(tidyverse)
library(cowplot)
install.packages("ggplot2")
library(ggplot2)
install.packages("ggpubr")
library(ggpubr)

#Reading in dataframe
Coweeta <- read.csv("./Data/Raw/1040_Hourly_CR10_1_2080.csv")
RG5 <- read.csv('./Data/Raw/RG05_daily_1992_2021.csv')
RG6 <- read.csv('./Data/Raw/RG06_daily_1936_2021.csv')
RG31 <- read.csv('./Data/Raw/RG31_daily_1958_2021.csv')

#Set theme

```

```{r}
#Check dimensions
dim(Coweeta)

#Check column names
colnames(Coweeta)

#Select columns:
Coweeta_wrangled <- Coweeta %>% select(site, Year, YearDay, smois30)
```

```{r}
#Addressing the date for Coweeta soil moisture
class(Coweeta_wrangled$YearDay)
class(Coweeta_wrangled$Year)

Coweeta_wrangled2 <- Coweeta_wrangled %>% 
  mutate(Date = as.Date(paste0(Year,"-",YearDay),format = "%Y-%j"))

#Creating a date column for rain gage dataset
RG5 <- RG5 %>% 
  mutate(Date = as.Date(paste0(YEAR,"-", MONTH,"-", DAY), format = "%Y-%m-%d"))

RG6 <- RG6 %>% 
  mutate(Date = as.Date(paste0(YEAR,"-", MONTH,"-", DAY), format = "%Y-%m-%d"))

RG31 <- RG31 %>% 
  mutate(Date = as.Date(paste0(YEAR,"-", MONTH,"-", DAY), format = "%Y-%m-%d"))
```

```{r}
#Checking the class of each variable
class(Coweeta_wrangled2$site)
class(Coweeta_wrangled2$Year)
class(Coweeta_wrangled2$YearDay)
class(Coweeta_wrangled2$smois30)
class(Coweeta_wrangled2$Date)

summary(Coweeta_wrangled2$Year)
```

```{r}
#Excluding smois30 values less than 0 and greater than 1 (soil moisture expressed as percent water content)

Coweeta_wrangled3 <- Coweeta_wrangled2 %>% 
  filter(smois30 >= 0 & smois30 <= 1) %>% 
  drop_na(Date) #dropped 1 na in the date column (day 366)

sum(is.na(Coweeta_wrangled3))
```

```{r}
#Separating 4 sites into 4 dataframes; checking all for NAs. Only site4 has NAs but it's only in the smois60 so we could just plan to use the smois 30 data instead? 

site1 <- Coweeta_wrangled3 %>% 
  filter(site == "1")
sum(is.na(site1))

site2 <- Coweeta_wrangled3 %>% 
  filter(site == "2")
sum(is.na(site2))

site3 <- Coweeta_wrangled3 %>% 
  filter(site == "3") %>% 
  drop_na(Date)
sum(is.na(site3$Date)) #showing 1 NA in the date column, could just drop the date? 

site4 <- Coweeta_wrangled3 %>% 
  filter(site == "4")
sum(is.na(site4$smois30))

```

```{r}
#Exporting dataframes into the 'Processed' data folder

#Site 1
write.csv(site1, file = "./Data/Processed/coweeta_site1.csv", row.names = FALSE)

#Site 2
write.csv(site2, file = "./Data/Processed/coweeta_site2.csv", row.names = FALSE)

#Site 3
write.csv(site3, file = "./Data/Processed/coweeta_site3.csv", row.names = FALSE)

#Site 4
write.csv(site4, file = "./Data/Processed/coweeta_site4.csv", row.names = FALSE)

#Coweeta_wrangled3
write.csv(Coweeta_wrangled3, file = "./Data/Processed/Coweeta_wrangled3.csv", row.names = FALSE)

```

```{r}
#wrangling the precipitation data to the years we have soil moisture data for 

RG5wrangled <- RG5 %>% 
  filter(YEAR >= 2000 & YEAR <= 2014)
RG6wrangled <- RG6 %>% 
  filter(YEAR >= 2000 & YEAR <= 2014)
RG31wrangled <- RG31 %>% 
  filter(YEAR >= 2000 & YEAR <= 2014)

```

```{r}
#Plotting 

site1_plot <- ggplot(site1, aes(x = Date, y = smois30)) +
  geom_line() +
  geom_smooth(method = lm)
print(site1_plot)

site2_plot <- ggplot(site2, aes(x = Date, y = smois30)) +
  geom_line() +
  geom_smooth(method = lm)
print(site2_plot)

site3_plot <- ggplot(site3, aes(x = Date, y = smois30)) +
  geom_line() +
  geom_smooth(method = lm)
print(site3_plot)

site4_plot <- ggplot(site4, aes(x = Date, y = smois30)) +
  geom_line() +
  geom_smooth(method = lm)
print(site4_plot)

```


```{r} 
#averaging soil mositure by MONTH for each site

#site1_averaged <-site1 %>% 
  #group_by(Date) %>% 
  #summarise(AverageDailySmois30 = mean(smois30))

site1_MonthAvg <-site1 %>% 
  mutate(Month = month(Date)) %>% 
  group_by(Year, Month) %>% 
  summarise(AverageMonthlySmois30 = mean(smois30)) %>% 
  mutate(YearMonth = as.Date(paste0(Year, "-", Month, "-", "01"), format = "%Y-%m-%d"))

#site2_averaged <- site2 %>% 
  #group_by(Date) %>% 
  #summarise(AverageDailySmois30 = mean(smois30))

site2_MonthAvg <-site2 %>% 
  mutate(Month = month(Date)) %>% 
  group_by(Year, Month) %>% 
  summarise(AverageMonthlySmois30 = mean(smois30)) %>% 
  mutate(YearMonth = as.Date(paste0(Year, "-", Month, "-", "01"), format = "%Y-%m-%d"))

#site3_averaged <- site3 %>% 
  #group_by(Date) %>% 
    #summarise(AverageDailySmois30 = mean(smois30))

site3_MonthAvg <-site3 %>% 
  mutate(Month = month(Date)) %>% 
  group_by(Year, Month) %>% 
  summarise(AverageMonthlySmois30 = mean(smois30)) %>% 
  mutate(YearMonth = as.Date(paste0(Year, "-", Month, "-", "01"), format = "%Y-%m-%d"))

#site4_averaged <- site4 %>% 
  #group_by(Date) %>% 
    #summarise(AverageDailySmois30 = mean(smois30))

site4_MonthAvg <-site4 %>% 
  mutate(Month = month(Date)) %>% 
  group_by(Year, Month) %>% 
  summarise(AverageMonthlySmois30 = mean(smois30)) %>% 
  mutate(YearMonth = as.Date(paste0(Year, "-", Month, "-", "01"), format = "%Y-%m-%d"))

```

```{r pressure, echo=FALSE}
#Plotting the daily averages
site1averaged_plot <- 
  ggplot(site1_MonthAvg, aes(x = YearMonth, y = AverageMonthlySmois30)) +
  geom_line() +
  geom_smooth(method = lm)+
  labs(x = "Year", y = "Average Daily Soil Moisture 30 cm (%)", title = "Site 1") +
  stat_regline_equation(label.y = 0.4)
print(site1averaged_plot)

site2averaged_plot <- 
  ggplot(site2_MonthAvg, aes(x = YearMonth, y = AverageMonthlySmois30)) +
  geom_line() +
  geom_smooth(method = lm)+
  labs(x = "Year", y = "Average Daily Soil Moisture 30 cm (%)", title = "Site 2") +
  stat_regline_equation(label.y = 0.4)
print(site2averaged_plot)

site3averaged_plot <- 
  ggplot(site3_MonthAvg, aes(x = YearMonth, y = AverageMonthlySmois30)) +
  geom_line() +
  geom_smooth(method = lm)+
  labs(x = "Year", y = "Average Daily Soil Moisture 30 cm (%)", title = "Site 3") +
  stat_regline_equation()
print(site3averaged_plot)

site4averaged_plot <- 
  ggplot(site4_MonthAvg, aes(x = YearMonth, y = AverageMonthlySmois30)) +
  geom_line() +
  geom_smooth(method = lm)+
  labs(x = "Year", y = "Average Daily Soil Moisture 30 cm (%)", title = "Site 4") +
  stat_regline_equation()
print(site4averaged_plot)

#playing around with cowplot
allaveragedplots <- plot_grid(site1averaged_plot, site2averaged_plot, site3averaged_plot, site4averaged_plot)
print(allaveragedplots)

```


```{r}
#Notes on time series

#Time series datasets come with several caveats, which need to be addressed in order to effectively model the system. A few common challenges that arise (and can occur together within a single dataset) are: 

#Autocorrelation: Data points are not independent from one another (i.e., the measurement at a given time point is dependent on previous time point(s)) - still only looking at one variable, just at different points in time

#Data gaps: Data are not collected at regular intervals, necessitating *interpolation* between measurements.

#Seasonality: seasonal patterns in variables occur at regular intervals, impeding clear interpretation of a monotonic (unidirectional) trend. relatively SHORT intervals (ex: dry vs wet seasons)

#Heteroscedasticity: The variance of the time series is not constant over time

#Covariance: the covariance of the time series is not constant over time

#creating a ts for each site
site1_ts <- ts(site1_averaged$AverageDailySmois30, start = c(2000, 1), frequency = 365)

site2_ts <- ts(site2_averaged$AverageDailySmois30, start = c(2000,1), frequency = 365)

site3_ts <- ts(site3_averaged$AverageDailySmois30, start = c(2000,1), frequency = 365)

site4_ts <- ts(site4_averaged$AverageDailySmois30, start = c(2000,1), frequency = 365)

#decomposing the ts

site1_decomposed <- stl(site1_ts, s.window = "periodic")

site2_decomposed <- stl(site2_ts, s.window = "periodic")

site3_decomposed <- stl(site3_ts, s.window = "periodic")

site4_decomposed <- stl(site4_ts, s.window = "periodic")

#plotting decomposed ts
#trend component seems to explain much of the variability in sites 3 & 4
#seasonality component seems to explain more of the variability in sites 1 & 2

plot(site1_decomposed) 
plot(site2_decomposed)
plot(site3_decomposed)
plot(site4_decomposed)

#Notes on Components

#Seasonal component: repeats over a fixed known period (e.g., seasons of the year, months, days of the week, hour of the day)

#Trend component: quantifies the upward or downward progression over time. The trend component of a time series does not have to be monotonic.

```

```{r}
#Monotonic trend analysis notes (will either be upward or downward)

#Linear regression: no seasonality, fits the assumptions of a parametric test. Function: `lm`

#Mann-Kendall: no seasonality, non-parametric, missing data allowed. Function: `MannKendall()` (package: Kendall)

#Seasonal Mann-Kendall: seasonality, non-parametric `SeasonalMannKendall` (package: Kendall)

#running trend analysis
library(Kendall)

site1_trend <- Kendall::SeasonalMannKendall(site1_ts)
summary(site1_trend)

site2_trend <- Kendall::SeasonalMannKendall(site2_ts)
summary(site2_trend)

site3_trend <- Kendall::SeasonalMannKendall(site3_ts)
summary(site3_trend)

site4_trend <- Kendall::SeasonalMannKendall(site4_ts)
summary(site4_trend)

```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r}

```

